<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RightFit ‚Äî The Smart Way to Choose Your Perfect Fit</title>
  <style>
    :root{
      --bg-1:#071227; --bg-2:#042034; --card:#0b1420; --muted:rgba(255,255,255,0.06);
      --accent:#2b6ef6; --ok:#10b981; --danger:#ef4444;
    }
    html,body{height:100%;}
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background: linear-gradient(180deg,var(--bg-1),var(--bg-2)); color:#e6eef8; min-height:100vh; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .container { max-width:920px; margin:32px auto; padding:0 16px 140px; box-sizing:border-box; }
    header{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:20px;}
    h1{margin:0;font-size:1.15rem}
    .small { font-size:0.92rem;color:#bcd3f0; }

    .card{background:var(--card); border-radius:12px; padding:18px; box-shadow:0 8px 28px rgba(2,6,23,0.6);}
    .p-6{padding:1.5rem;}
    input[type="number"], select{width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--muted); background:transparent; color:inherit; box-sizing:border-box;}
    .btn-row{display:flex; gap:10px; align-items:center; margin-top:12px;}
    button{padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600;}
    .primary{background:var(--accent); color:#fff;}
    .muted{background:transparent; border:1px solid var(--muted); color:#dbeafe;}
    .chip{background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:999px; color:#cfe6ff;}
    .brands{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px;}
    .brand-btn{display:inline-flex; align-items:center; justify-content:center; min-width:84px; padding:8px 10px; border-radius:10px; text-decoration:none; color:#fff; font-weight:700; font-size:0.88rem;}
    .brand-btn.small{min-width:72px; font-size:0.82rem; padding:6px 8px;}
    .hidden{display:none;}
    #resultImage{width:120px; height:120px; object-fit:cover; border-radius:8px; background:#0f1724; flex:0 0 120px;}
    #resultsCard .card{margin-top:18px;}
    .result-main{display:flex; gap:16px; align-items:flex-start;}
    .result-meta{flex:1;}
    .notes{margin-top:8px; color:#cfe6ff; font-size:0.95rem;}
    pre{background:rgba(0,0,0,0.28); padding:10px; overflow:auto; border-radius:8px; color:#dbeafe; margin:0;}
    .debug-hidden{display:none !important;}
    @media (max-width:720px){
      .result-main{flex-direction:column; align-items:center;}
      #resultImage{width:100%; height:160px; flex:0 0 auto;}
      .brand-btn{min-width:72px; font-size:0.82rem; padding:8px;}
    }
    .sr-only{position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;}
    body:after{content:""; display:block; height:100px;}
    /* Highlighted bra-size styles */
    .size-head { font-size:1.25rem; font-weight:800; color:#fff; background: linear-gradient(90deg, rgba(43,110,246,0.12), rgba(124,58,237,0.06)); padding:10px 14px; border-radius:10px; display:inline-block; }
    .size-sub { margin-top:8px; color:#dbeafe; font-weight:600; }
  </style>
</head>
<body>
  <!-- Loading Screen -->
<div id="loader">
    <div class="spinner"></div>
</div>
  
  <div class="container">
    <header>
      <div>
        <h1>RightFit</h1>
        <div class="small">The Smart Way to Choose Your Perfect Fit</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="darkToggle" class="muted small">Dark sample</button>
        <button id="aiMode" class="muted small">AI sample</button>
      </div>
    </header>

    <!-- form -->
    <section class="card p-6" aria-labelledby="form-title">
      <h2 id="form-title" class="text-lg" style="margin:0 0 .5rem 0">Get Your Recommendation</h2>
      <div style="display:flex; flex-direction:column; gap:10px;">
        <input id="bandInput" type="number" placeholder="Underbust (band) cm" value="78" aria-label="Band underbust in cm">
        <input id="bustInput" type="number" placeholder="Full bust (bust) cm" value="90" aria-label="Bust full bust in cm">
        <select id="activityInput" aria-label="Activity preference">
          <option>Daily / Casual</option>
          <option>Sports / Active</option>
          <option>High Impact</option>
        </select>
        <select id="rootInput" aria-label="Root width">
          <option>Narrow</option>
          <option>Average</option>
          <option>Wide</option>
        </select>

        <div class="btn-row">
          <button id="searchBtn" class="primary">Search</button>
          <button id="resetBtn" class="muted">Reset</button>
          <span id="statusChip" class="chip" style="margin-left:auto">Ready</span>
        </div>
      </div>
    </section>

    <!-- results (simplified) -->
    <section id="resultsCard" class="card p-6 hidden" aria-live="polite">
      <div class="result-main" style="align-items:flex-start;">
        <!-- compact image kept but small and not labeled -->
        <img id="resultImage" src="" alt="" class="sr-only" style="width:1px;height:1px;opacity:0;"/>
        <div class="result-meta">
          <!-- PROMINENT BRA SIZE ONLY -->
          <div id="sizeHeadline" class="size-head">Comfort 78 ‚Äî Daily / Casual</div>
          <!-- concise meta under the headline -->
          <div id="sizeMeta" class="size-sub">Band: <strong id="bandVal">--</strong> &nbsp; | &nbsp; Bust: <strong id="bustVal">--</strong> &nbsp; | &nbsp; Cup: <strong id="cupVal">--</strong></div>

          <!-- notes kept short -->
          <div id="notesArea" class="notes" aria-hidden="false"></div>

          <!-- brand buttons -->
          <div class="brands" id="brandButtons" style="margin-top:12px;">
            <a id="zivameBtn" class="brand-btn" style="background:#ff6b6b">Zivame</a>
            <a id="cloviaBtn" class="brand-btn" style="background:#ff73a0">Clovia</a>
            <a id="shyawayBtn" class="brand-btn" style="background:#ff5fb7">Shyaway</a>
            <a id="enamorBtn" class="brand-btn" style="background:#7c3aed">Enamor</a>
            <a id="amazonBtn" class="brand-btn small" style="background:#f59e0b">Amazon</a>
            <a id="flipkartBtn" class="brand-btn small" style="background:#0369a1">Flipkart</a>
            <a id="myntraBtn" class="brand-btn small" style="background:#ec4899">Myntra</a>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- small floating banner -->
  <div style="position:fixed; left:12px; bottom:12px; z-index:9999;">
    <div style="background:rgba(0,0,0,0.6); padding:10px 12px; border-radius:8px; display:flex; gap:8px; align-items:center;">
      <span class="small">üéÅ Chance for free ‚Çπ200 gift voucher</span>
      <a class="chip" href="https://spinwheel-aoae.onrender.com" target="_blank" rel="noopener noreferrer" style="margin-left:8px; background:var(--ok); color:#041024; text-decoration:none;">Click here</a>
    </div>
  </div>

  <script>
  /********** Config **********/
  const EXCLUDED = new Set(['amazon','flipkart','myntra']);
  const BACKEND_API = '/api/results';

  /********** computeBraSize (same defensive function) **********/
  function computeBraSize(bandInput, bustInput, unitHint = undefined) {
    const toNumber = v => { const n = Number(v); return Number.isFinite(n) ? n : NaN; };
    let band = toNumber(bandInput), bust = toNumber(bustInput);
    if (Number.isNaN(band) || Number.isNaN(bust)) return { error:true, message:'Invalid measurements' };
    let unit = unitHint ? unitHint.toLowerCase() : (band > 40 || bust > 40 ? 'cm' : 'in');
    const inToCm = x => x * 2.54, cmToIn = x => x / 2.54;
    const bandCmRaw = unit === 'in' ? inToCm(band) : band;
    const bustCmRaw = unit === 'in' ? inToCm(bust) : bust;
    const stdBands = [65,70,75,80,85,90,95,100,105,110,115,120];
    const bandNearest = stdBands.reduce((best, b) => Math.abs(b - bandCmRaw) < Math.abs(best - bandCmRaw) ? b : best, stdBands[0]);
    const diffCm = Math.max(0, bustCmRaw - bandNearest);
    const diffInch = diffCm / 2.54;
    const cupIndex = Math.round(diffInch);
    const cupMap = {0:'AA',1:'A',2:'B',3:'C',4:'D',5:'DD',6:'E',7:'F',8:'FF'};
    const cupLetter = cupMap[Math.max(0, Math.min(8, cupIndex))] || 'G';
    const bandInch = +(cmToIn(bandNearest)).toFixed(1);
    const sizeStringCm = `${bandNearest}${cupLetter}`;
    const sizeStringIn = `${Math.round(bandInch)}${cupLetter}`;
    function shiftCup(letter, shift) {
      const ordered = ['AA','A','B','C','D','DD','E','F','G','H'];
      const idx = ordered.indexOf(letter); if (idx === -1) return letter;
      return ordered[Math.max(0, Math.min(ordered.length-1, idx + shift))];
    }
    const alternatives = [];
    const idxBand = stdBands.indexOf(bandNearest);
    if (idxBand !== -1) {
      if (idxBand + 1 < stdBands.length) alternatives.push({ bandCm: stdBands[idxBand+1], cup: shiftCup(cupLetter,-1), size:`${stdBands[idxBand+1]}${shiftCup(cupLetter,-1)}` });
      if (idxBand - 1 >= 0) alternatives.push({ bandCm: stdBands[idxBand-1], cup: shiftCup(cupLetter,1), size:`${stdBands[idxBand-1]}${shiftCup(cupLetter,1)}` });
    }
    const notes = [`Used band ‚âà ${bandNearest} cm (rounded).`, `Bust - band = ${Math.round(diffCm)} cm (~${diffInch.toFixed(2)} in) ‚Üí cup ${cupLetter}.`];
    return { error:false, unit, bandInput:band, bustInput:bust, bandNearest, bandInch, bustInch: +(cmToIn(bustCmRaw)).toFixed(1), differenceCm:+diffCm.toFixed(1), differenceInch:+diffInch.toFixed(2), cupLetter, sizeStringCm, sizeStringIn, sisterSizes:alternatives, notes };
  }

  /********** Safe link helpers (only backend URLs are used) **********/
  function applyLinkToElement(el, url) {
    if (!el) return;
    el.setAttribute('href', url);
    el.setAttribute('target', '_blank');
    el.setAttribute('rel', 'noopener noreferrer');
    el.classList.remove('disabled');
    el.style.display = '';
  }
  function hideElement(el){ if (!el) return; el.style.display = 'none'; }
  function setStoreLink(id, url) {
    const el = document.getElementById(id);
    if (!el) return;
    if (url) applyLinkToElement(el, url); else hideElement(el);
  }

  /********** Lightweight fetch retry **********/
  async function fetchWithRetry(url, options={}, retries=2, delayMs=1000) {
    for (let i=0;i<=retries;i++){
      try {
        const r = await fetch(url, options);
        if (!r.ok) {
          if (r.status >= 500 && i < retries) { await new Promise(r=>setTimeout(r,delayMs)); continue; }
          const txt = await r.text().catch(()=>null);
          throw new Error(`HTTP ${r.status} ${txt?': '+txt:''}`);
        }
        return await r.json();
      } catch (err) {
        if (i === retries) throw err;
        await new Promise(r=>setTimeout(r,delayMs));
      }
    }
  }

  /********** DOM wiring **********/
  document.addEventListener('DOMContentLoaded', () => {
    const searchBtn = document.getElementById('searchBtn');
    const resetBtn = document.getElementById('resetBtn');
    const statusChip = document.getElementById('statusChip');
    const notesArea = document.getElementById('notesArea');
    const sizeHeadline = document.getElementById('sizeHeadline');
    const sizeMeta = document.getElementById('sizeMeta');

    document.getElementById('darkToggle').addEventListener('click', (e)=> {
      const btn=e.currentTarget; btn.textContent = btn.textContent.includes('ON') ? 'Dark sample' : 'Dark sample: ON';
    });
    document.getElementById('aiMode').addEventListener('click', (e)=> {
      const btn=e.currentTarget; btn.textContent = btn.textContent.includes('ON') ? 'AI sample' : 'AI sample ON';
    });

    searchBtn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      statusChip.textContent = 'Searching‚Ä¶';
      searchBtn.disabled = true;
      searchBtn.textContent = 'Searching...';

      const bandRaw = parseFloat(document.getElementById("bandInput").value) || 78;
      const bustRaw = parseFloat(document.getElementById("bustInput").value) || 90;
      const activity = document.getElementById("activityInput").value || "Daily / Casual";
      const root = document.getElementById("rootInput").value || "Narrow";

      // compute local size
      const local = computeBraSize(bandRaw, bustRaw);
      if (local.error) { alert(local.message || 'Invalid'); searchBtn.disabled=false; searchBtn.textContent='Search'; statusChip.textContent='Ready'; return; }

      // send payload (backend may override cup_letter/band)
      const payload = { band_input: bandRaw, bust_input: bustRaw, band_computed: local.bandNearest, cup_computed: local.cupLetter, activity, root };

      let data = {};
      try {
        data = await fetchWithRetry(BACKEND_API, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) }, 2, 1100);
      } catch (err) {
        console.warn('Backend fetch failed, using local values', err);
        data = {};
      }

      // final values prefer backend when provided
      const bandToShow = data.band || local.bandNearest;
      const bustToShow =
        data.bust ||
        Math.round(local.bustInch ? local.bustInch * 2.54 : local.bustInch) ||
        Math.round(local.bustInput);

      const cupLetterToShow = data.cup_letter || local.cupLetter;
      const diffCmToShow = data.cup_diff ?? local.differenceCm;

      // Build display strings: sizeNumber + cupLetter (e.g. "78E")
      const displaySizeNumberLetter = `${bandToShow}${cupLetterToShow}`;

      // Headline: show brand-like label + number+letter + activity
      // Example: "Comfort 78E ‚Äî Daily / Casual"
      const headlineText = `Comfort ${displaySizeNumberLetter} ‚Äî ${activity}`;

      // Set headline and concise meta
      sizeHeadline.textContent = headlineText;
      document.getElementById("bandVal").textContent = bandToShow;
      document.getElementById("bustVal").textContent = bustToShow;

      // show cup letter and numeric diff
      document.getElementById("cupVal").textContent =
        `${cupLetterToShow} (diff ${Math.round(diffCmToShow)} cm)`;

      notesArea.textContent 
      = local.notes.join(" ‚Ä¢ ");

      // set brand links using only backend URLs (no fallbacks)
      setStoreLink("zivameBtn",  "https://www.zivame.com");
      setStoreLink("cloviaBtn",  "https://www.clovia.com");
      setStoreLink("shyawayBtn", "https://www.shyaway.com");
      setStoreLink("enamorBtn",  "https://www.enamor.co.in");
      setStoreLink("amazonBtn",  data.store_urls?.amazon || null);
      setStoreLink("flipkartBtn", data.store_urls?.flipkart || null);
      setStoreLink("myntraBtn",  data.store_urls?.myntra || null);

      // show results card (only the highlighted size + concise meta)
      document.getElementById('resultsCard').classList.remove('hidden');

      // finalize UI state
      searchBtn.disabled = false;
      searchBtn.textContent = 'Search';
      statusChip.textContent = 'Ready';

      // scroll to results smoothly
      setTimeout(()=> window.scrollTo({ top: document.getElementById("resultsCard").offsetTop - 20, behavior: "smooth" }), 120);
    });

    resetBtn.addEventListener('click', (e)=>{ e.preventDefault();
      document.getElementById("bandInput").value = 78;
      document.getElementById("bustInput").value = 90;
      document.getElementById("activityInput").value = "Daily / Casual";
      document.getElementById("rootInput").value = "Narrow";
      document.getElementById("resultsCard").classList.add('hidden');
      document.getElementById('statusChip').textContent = 'Ready';
    });
  });
  </script>
  <script>
document.addEventListener("DOMContentLoaded", function () {
    // Remove loading screen after content is ready
    const loader = document.getElementById("loader");
    setTimeout(() => {
        loader.style.opacity = "0";
        loader.style.transition = "0.4s";
        setTimeout(() => (loader.style.display = "none"), 400);
    }, 300); // (Optional delay)
});
  </script>
  
</body>
</html>
